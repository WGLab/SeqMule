#!/usr/bin/env perl

use strict;
use warnings;
use File::Basename qw/basename/;
use File::Spec;

my $ncpu=4;
#my $mem="4.5g";
my $mem="6g"; #request larger mem for GATK
my $jmem="2500m";
my $gatknt=4;
my $exe="/home/yunfeiguo/projects/SeqMule_dev/bin/seqmule";
my $test_folder="/home/yunfeiguo/projects/data/test";
my $config_folder="/home/yunfeiguo/projects/SeqMule/misc/predefined_config";
#for no merge, no ms
my $first_fq="part.1.fastq";
my $second_fq="part.2.fastq";
my $prefix="part";
#for merge
my @first_fq=("5181-2_S1-1_L001_R1_001.fastq","5181-2_S1_L001_R1_001.fastq");
my @second_fq=("5181-2_S1-1_L001_R2_001.fastq","5181-2_S1_L001_R2_001.fastq");
my $merge_prefix="R12";
my $merge_capture="/home/yunfeiguo/projects/data/test/merge_capture.bed";

my $basic; 
my $basic_merge;
my $basic_ms;
my @config_files=glob "$config_folder/*.config";

$basic="$exe pipeline -prefix $prefix -a $first_fq -b $second_fq -e -capture default -t $ncpu -jmem $jmem -gatknt $gatknt";
$basic_merge="$exe pipeline -merge --forceOneRG -rg colonRG -prefix $merge_prefix -a ".join(',',@first_fq)." -b ".join(',',@second_fq)." -e -t $ncpu -jmem $jmem -gatknt $gatknt -capture $merge_capture";
$basic_ms="$exe pipeline -a ".join(',',@first_fq,$first_fq)." -b ".join(',',@second_fq,$second_fq)." -rg colon1,colon2,part -capture default -e -t $ncpu -jmem $jmem -ms -prefix one,two,three -gatknt $gatknt";

chdir $test_folder or die "Can't enter $test_folder: $!\n";
my $count=0;

for my $q("","-quick")
{
    for my $j(@config_files)
    {
	for my $ms("","-ms","-merge")
	{
	    next if $ms eq '-ms';
		my @cmd;
		my @target_files;
		my $starting_point;
		my $job="n$count";
		my $tmp_dir=$job.basename($j)."-$q-$ms";

		$tmp_dir=~s/[\.\/]/_/g;
		$tmp_dir=~s/-+/-/g;
		$tmp_dir=~s/-$//g;

		push @cmd,"rm -rf $tmp_dir" if -d $tmp_dir;
		push @cmd,"mkdir $tmp_dir";
		push @cmd,"cd $tmp_dir";

		if ($ms eq '')
		{
		    @target_files=($first_fq,$second_fq);
		    $starting_point=$basic;

		} elsif ($ms eq '-merge')
		{
		    @target_files=(@first_fq,@second_fq);
		    $starting_point=$basic_merge;
		} elsif ($ms eq '-ms')
		{
		    $starting_point=$basic_ms;

		}

		for (@target_files)
		{
		    my $target=File::Spec->catfile($test_folder,$_);
		    push @cmd,"ln -sf $target .";
		}
		#push @cmd, "echo '$starting_point $q --advanced $j' | qsub -l h=\"compute-0-1[0-9]\" -l h_vmem=$mem -V -cwd -pe smp $ncpu -N $job -m ea -M guoyunfei1989\@gmail.com";
		push @cmd, "echo '$starting_point $q --advanced $j' | qsub -l h=\"compute-0-1[0-9]\" -l h_vmem=$mem -V -cwd -pe smp $ncpu -N $job";
		#push @cmd, "$starting_point $q --advanced $j";
		#after job is submitted, return to parent folder
		push @cmd, "cd $test_folder";

		#&exec(@cmd) if grep{$count==$_} (84,86,88,90,92,96,98);
		&exec(@cmd) and exit if ($j=~/gatk/ && $j=~/samtools/);
		$count++;
	}
    }
}


sub exec
{
    my @cmd=@_;
    my $tmp="/tmp/seqmule_test.$$".rand($$);
    open OUT,'>',$tmp or die "Can't open $tmp: $!\n";
    print OUT "#!/bin/sh\nset -e\n";
    print OUT join("\n",@cmd);
    close OUT;
    chmod 0755,$tmp;
    !system($tmp) or die "Failed to run $tmp\n";
}
